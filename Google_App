// === CONFIG ===
const SHEET_ID        = '1h-INUM0-C9KP8-HcXrm5iY4WIIY-rU0gwvzn_YmCZ4A';
const ALL_SHEET_NAME  = 'All';
const RESP_SHEET_NAME = 'Responses';

/**
 * Ensure headers for All + Responses.
 * If headers already exist, we extend them if new columns were added.
 */
function ensureHeaders_() {
  const ss   = SpreadsheetApp.openById(SHEET_ID);
  const all  = ss.getSheetByName(ALL_SHEET_NAME);
  const resp = ss.getSheetByName(RESP_SHEET_NAME);

  if (!all)  throw new Error('Sheet "All" not found');
  if (!resp) throw new Error('Sheet "Responses" not found');

  const allHeaders = [
    'timestamp',
    'session_id',
    'source',
    'page_url',
    'referrer',
    'user_agent',
    'browser_language',
    'timezone',
    'utm_source',
    'utm_medium',
    'utm_campaign',
    'utm_term',
    'utm_content',
    'total_score',
    'max_total',
    'overall_percent',
    'risk_index',
    'overall_zone',
    'focus_area_label',
    'score_workload',
    'score_control',
    'score_reward',
    'score_community',
    'score_fairness',
    'score_values',
    'score_restoration',

    // 21 raw answers
    'workload_q1',
    'workload_q2',
    'workload_q3',
    'control_q1',
    'control_q2',
    'control_q3',
    'reward_q1',
    'reward_q2',
    'reward_q3',
    'community_q1',
    'community_q2',
    'community_q3',
    'fairness_q1',
    'fairness_q2',
    'fairness_q3',
    'values_q1',
    'values_q2',
    'values_q3',
    'restoration_q1',
    'restoration_q2',
    'restoration_q3'
  ];

  const respHeaders = [
    'timestamp',
    'session_id',
    'source',
    'page_url',
    'referrer',
    'user_agent',
    'browser_language',
    'timezone',
    'utm_source',
    'utm_medium',
    'utm_campaign',
    'utm_term',
    'utm_content',

    'name',
    'email',
    'role',
    'org_size',
    'industry',
    'country',
    'marketing_opt_in'

    'total_score',
    'max_total',
    'overall_percent',
    'risk_index',
    'overall_zone',
    'focus_area_label',
    'score_workload',
    'score_control',
    'score_reward',
    'score_community',
    'score_fairness',
    'score_values',
    'score_restoration',

    'results_html'
  ];

  // Helper to set or extend header row
  function syncHeaderRow(sheet, targetHeaders) {
    const lastRow = sheet.getLastRow();
    const lastCol = sheet.getLastColumn();

    if (lastRow === 0) {
      // Sheet empty: write full header row
      sheet.getRange(1, 1, 1, targetHeaders.length).setValues([targetHeaders]);
      return;
    }

    // Sheet has data → read current header row and extend if needed
    const existing = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    const currentLen = existing.filter(String).length; // non-empty cells

    if (currentLen < targetHeaders.length) {
      const missing = targetHeaders.slice(currentLen);
      sheet.getRange(1, currentLen + 1, 1, missing.length).setValues([missing]);
    }
  }

  syncHeaderRow(all,  allHeaders);
  syncHeaderRow(resp, respHeaders);

  return {
    all,
    resp,
    allHeaders,
    respHeaders
  };
}

/**
 * Build a row for the All sheet from quiz-only payload.
 */
function buildAllRow_(payload, headers) {
  const now = new Date();
  const p = payload || {};

  const row = headers.map(function (h) {
    switch (h) {
      case 'timestamp':        return now;
      case 'session_id':       return p.session_id || '';
      case 'source':           return p.source     || '';
      case 'page_url':         return p.page_url   || '';
      case 'referrer':         return p.referrer   || '';
      case 'user_agent':       return p.user_agent || '';
      case 'browser_language': return p.browser_language || '';
      case 'timezone':         return p.timezone   || '';

      case 'utm_source':       return p.utm_source   || '';
      case 'utm_medium':       return p.utm_medium   || '';
      case 'utm_campaign':     return p.utm_campaign || '';
      case 'utm_term':         return p.utm_term     || '';
      case 'utm_content':      return p.utm_content  || '';

      case 'total_score':      return p.total_score      || 0;
      case 'max_total':        return p.max_total        || 0;
      case 'overall_percent':  return p.overall_percent  || 0;
      case 'risk_index':       return p.risk_index       || 0;
      case 'overall_zone':     return p.overall_zone     || '';
      case 'focus_area_label': return p.focus_area_label || '';

      case 'score_workload':    return p.score_workload    || 0;
      case 'score_control':     return p.score_control     || 0;
      case 'score_reward':      return p.score_reward      || 0;
      case 'score_community':   return p.score_community   || 0;
      case 'score_fairness':    return p.score_fairness    || 0;
      case 'score_values':      return p.score_values      || 0;
      case 'score_restoration': return p.score_restoration || 0;

      case 'workload_q1':    return p.workload_q1    || 0;
      case 'workload_q2':    return p.workload_q2    || 0;
      case 'workload_q3':    return p.workload_q3    || 0;
      case 'control_q1':     return p.control_q1     || 0;
      case 'control_q2':     return p.control_q2     || 0;
      case 'control_q3':     return p.control_q3     || 0;
      case 'reward_q1':      return p.reward_q1      || 0;
      case 'reward_q2':      return p.reward_q2      || 0;
      case 'reward_q3':      return p.reward_q3      || 0;
      case 'community_q1':   return p.community_q1   || 0;
      case 'community_q2':   return p.community_q2   || 0;
      case 'community_q3':   return p.community_q3   || 0;
      case 'fairness_q1':    return p.fairness_q1    || 0;
      case 'fairness_q2':    return p.fairness_q2    || 0;
      case 'fairness_q3':    return p.fairness_q3    || 0;
      case 'values_q1':      return p.values_q1      || 0;
      case 'values_q2':      return p.values_q2      || 0;
      case 'values_q3':      return p.values_q3      || 0;
      case 'restoration_q1': return p.restoration_q1 || 0;
      case 'restoration_q2': return p.restoration_q2 || 0;
      case 'restoration_q3': return p.restoration_q3 || 0;

      default: return '';
    }
  });

  return row;
}

/**
 * Build a row for the Responses sheet from follow-up payload.
 */
function buildResponsesRow_(payload, headers) {
  const now = new Date();
  const p = payload || {};

  const row = headers.map(function (h) {
    switch (h) {
      case 'timestamp':        return now;
      case 'session_id':       return p.session_id || '';
      case 'source':           return p.source     || '';
      case 'page_url':         return p.page_url   || '';
      case 'referrer':         return p.referrer   || '';
      case 'user_agent':       return p.user_agent || '';
      case 'browser_language': return p.browser_language || '';
      case 'timezone':         return p.timezone   || '';

      case 'utm_source':       return p.utm_source   || '';
      case 'utm_medium':       return p.utm_medium   || '';
      case 'utm_campaign':     return p.utm_campaign || '';
      case 'utm_term':         return p.utm_term     || '';
      case 'utm_content':      return p.utm_content  || '';

      case 'name':             return p.name     || '';
      case 'email':            return p.email    || '';
      case 'role':             return p.role     || '';
      case 'org_size':         return p.org_size || '';
      case 'industry':         return p.industry || '';
      case 'country':          return p.country  || '';

      case 'total_score':      return p.total_score      || 0;
      case 'max_total':        return p.max_total        || 0;
      case 'overall_percent':  return p.overall_percent  || 0;
      case 'risk_index':       return p.risk_index       || 0;
      case 'overall_zone':     return p.overall_zone     || '';
      case 'focus_area_label': return p.focus_area_label || '';

      case 'score_workload':    return p.score_workload    || 0;
      case 'score_control':     return p.score_control     || 0;
      case 'score_reward':      return p.score_reward      || 0;
      case 'score_community':   return p.score_community   || 0;
      case 'score_fairness':    return p.score_fairness    || 0;
      case 'score_values':      return p.score_values      || 0;
      case 'score_restoration': return p.score_restoration || 0;

      case 'results_html':      return p.results_html || '';

      default: return '';
    }
  });

  return row;
}

/**
 * Web app entry point.
 * Expects POST with form field `data` containing JSON.
 */
function doPost(e) {
  try {
    const raw = (e && e.parameter && e.parameter.data) || '';
    if (!raw) {
      throw new Error('Missing data parameter');
    }

    const payload = JSON.parse(raw);
    const source  = payload.source || 'quiz';

    const { all, resp, allHeaders, respHeaders } = ensureHeaders_();

    if (source === 'quiz') {
      const row = buildAllRow_(payload, allHeaders);
      all.appendRow(row);
    } else if (source === 'followup') {
      const row = buildResponsesRow_(payload, respHeaders);
      resp.appendRow(row);
    } else {
      // unknown source – log but don't crash
      Logger.log('Unknown source in payload: ' + source);
    }

    return ContentService
      .createTextOutput(JSON.stringify({ status: 'ok' }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (err) {
    Logger.log('doPost error: ' + err);
    return ContentService
      .createTextOutput(JSON.stringify({ status: 'error', message: String(err) }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * === TEST HELPERS YOU CAN RUN MANUALLY ===
 * These don't depend on Squarespace at all.
 */

function test_QuizRow() {
  const { all, allHeaders } = ensureHeaders_();
  const fakePayload = {
    source: 'quiz',
    session_id: 'test-session-123',
    page_url: 'https://example.com',
    referrer: 'https://google.com',
    user_agent: 'Test UA',
    browser_language: 'en-CA',
    timezone: 'America/Toronto',
    utm_source: 'google',
    utm_medium: 'cpc',
    utm_campaign: 'burnout-test',

    total_score: 72,
    max_total: 105,
    overall_percent: 69,
    risk_index: 31,
    overall_zone: 'At-risk',
    focus_area_label: 'Workload',

    score_workload: 8,
    score_control: 10,
    score_reward: 9,
    score_community: 11,
    score_fairness: 12,
    score_values: 10,
    score_restoration: 12,

    // raw answers – arbitrary test numbers
    workload_q1: 2,
    workload_q2: 3,
    workload_q3: 3,
    control_q1: 3,
    control_q2: 3,
    control_q3: 3,
    reward_q1: 4,
    reward_q2: 3,
    reward_q3: 2,
    community_q1: 3,
    community_q2: 4,
    community_q3: 4,
    fairness_q1: 5,
    fairness_q2: 4,
    fairness_q3: 3,
    values_q1: 4,
    values_q2: 5,
    values_q3: 5,
    restoration_q1: 3,
    restoration_q2: 4,
    restoration_q3: 3
  };

  const row = buildAllRow_(fakePayload, allHeaders);
  all.appendRow(row);
}

function test_ResponseRow() {
  const { resp, respHeaders } = ensureHeaders_();
  const fakePayload = {
    source: 'followup',
    session_id: 'test-session-123',
    page_url: 'https://example.com',
    referrer: 'https://google.com',
    user_agent: 'Test UA',
    browser_language: 'en-CA',
    timezone: 'America/Toronto',
    utm_source: 'google',
    utm_medium: 'cpc',
    utm_campaign: 'burnout-test',

    name: 'Test Person',
    email: 'test@example.com',
    role: 'Manager',
    org_size: '50–249 employees',
    industry: 'Healthcare',
    country: 'Canada',

    total_score: 72,
    max_total: 105,
    overall_percent: 69,
    risk_index: 31,
    overall_zone: 'At-risk',
    focus_area_label: 'Workload',

    score_workload: 8,
    score_control: 10,
    score_reward: 9,
    score_community: 11,
    score_fairness: 12,
    score_values: 10,
    score_restoration: 12,

    results_html: '<p>Sample results HTML</p>'
  };

  const row = buildResponsesRow_(fakePayload, respHeaders);
  resp.appendRow(row);
}
